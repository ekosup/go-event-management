{{define "content"}}
<div class="container p-8 mx-auto" x-data="eventDetailsPage">
    <h1 class="text-3xl font-bold" x-text="event ? event.name : 'Event Details'">Event Details</h1>

    <div x-show="loading" class="flex items-center justify-center h-32">
        <div class="w-16 h-16 border-t-4 border-blue-500 border-solid rounded-full animate-spin"></div>
    </div>

    <div x-show="!loading && event" class="grid grid-cols-1 gap-8 mt-8 md:grid-cols-2">
        <!-- Event Details -->
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold">Event Information</h2>
            <p class="mt-4"><strong class="font-semibold">Description:</strong> <span x-text="event.description"></span></p>
            <p class="mt-2"><strong class="font-semibold">Date & Time:</strong> <span x-text="new Date(event.date_time).toLocaleString()"></span></p>

            <!-- Edit Event Form -->
            <h3 class="mt-8 text-xl font-bold">Edit Event</h3>
            <form @submit.prevent="updateEvent()" class="mt-4 space-y-4" x-show="event">
                <div>
                    <label for="editName" class="block text-sm font-medium text-gray-700">Event Name</label>
                    <input type="text" id="editName" x-model="event.name" class="w-full px-3 py-2 mt-1 border rounded-md" required>
                </div>
                <div>
                    <label for="editDescription" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="editDescription" x-model="event.description" class="w-full px-3 py-2 mt-1 border rounded-md" required></textarea>
                </div>
                <div>
                    <label for="editDateTime" class="block text-sm font-medium text-gray-700">Date and Time</label>
                    <input type="datetime-local" id="editDateTime" x-model="event.date_time" class="w-full px-3 py-2 mt-1 border rounded-md" required>
                </div>
                <button type="submit" class="px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">Update Event</button>
            </form>
        </div>

        <!-- Guest Management -->
        <div class="p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold">Guests</h2>

            <!-- Add Guest Form -->
            <h3 class="mt-4 text-xl font-bold">Add New Guest</h3>
            <form @submit.prevent="addGuest()" class="mt-4 space-y-4" x-show="event">
                <div>
                    <label for="guestName" class="block text-sm font-medium text-gray-700">Guest Name</label>
                    <input type="text" id="guestName" x-model="newGuest.name" class="w-full px-3 py-2 mt-1 border rounded-md" required>
                </div>
                <div>
                    <label for="guestEmail" class="block text-sm font-medium text-gray-700">Guest Email</label>
                    <input type="email" id="guestEmail" x-model="newGuest.email" class="w-full px-3 py-2 mt-1 border rounded-md" required>
                <button type="submit" class="px-4 py-2 font-semibold text-white bg-green-600 rounded-md hover:bg-green-700">Add Guest</button>
                </div>
            </form>

            <!-- Guest List -->
            <h3 class="mt-8 text-xl font-bold">Guest List</h3>
            <ul class="mt-4 space-y-4" x-show="event && event.Guests && event.Guests.length > 0">
                <template x-for="guest in event.Guests" :key="guest.ID">
                    <li class="p-4 border rounded-md">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-semibold" x-text="guest.name"></p>
                                <p class="text-sm text-gray-600" x-text="guest.email"></p>
                            </div>
                            <button @click="showQrCode(guest.qr_code)" class="px-3 py-1 text-sm text-white bg-purple-600 rounded-md hover:bg-purple-700">Show QR</button>
                        </div>
                    </li>
                </template>
            </ul>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="fixed inset-0 z-10 overflow-y-auto" style="display: none;" x-show="qrCodeModalOpen">
        <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block overflow-hidden text-left align-bottom transition-all transform bg-white rounded-lg shadow-xl sm:my-8 sm:align-middle sm:max-w-sm sm:w-full" role="dialog" aria-modal="true" aria-labelledby="modal-headline">
                <div class="px-4 pt-5 pb-4 bg-white sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg font-medium leading-6 text-gray-900" id="modal-headline">QR Code</h3>
                            <div class="mt-2">
                                <img x-bind:src="'data:image/png;base64,' + currentQrCode" alt="QR Code">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="px-4 py-3 bg-gray-50 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="qrCodeModalOpen = false" type="button" class="inline-flex justify-center w-full px-4 py-2 text-base font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('eventDetailsPage', () => ({
            event: null,
            newGuest: { name: '', email: '' },
            qrCodeModalOpen: false,
            currentQrCode: '',
            init() {
                const eventID = window.location.pathname.split('/').pop()
                console.log('EventDetailsPage: Initializing with eventID:', eventID)
                this.fetchEvent(eventID)
            },
            fetchEvent(eventID) {
                this.loading = true
                console.log('EventDetailsPage: Fetching event with ID:', eventID)
                fetch(`/api/events/${eventID}`)
                    .then(response => {
                        console.log('EventDetailsPage: API response status:', response.status)
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`)
                        }
                        return response.json()
                    })
                    .then(data => {
                        console.log('EventDetailsPage: Fetched event data:', data)
                        this.event = data
                    })
                    .catch(error => {
                        console.error('EventDetailsPage: Error fetching event:', error)
                        this.event = null // Clear event data on error
                    })
                    .finally(() => {
                        this.loading = false
                    })
            },
            updateEvent() {
                fetch(`/api/events/${this.event.ID}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.event)
                })
                .then(() => this.fetchEvent(this.event.ID))
            },
            addGuest() {
                console.log('AddGuest: Adding new guest.')
                fetch('/api/guests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...this.newGuest, event_id: this.event.ID })
                })
                .then(() => {
                    console.log('AddGuest: Guest added successfully. Refetching event.')
                    this.newGuest = { name: '', email: '' }
                    this.fetchEvent(this.event.ID)
                })
                .catch(error => {
                    console.error('AddGuest: Error adding guest:', error)
                })
            },
            showQrCode(qrCode) {
                this.currentQrCode = qrCode
                this.qrCodeModalOpen = true
            }
        }))
    })
</script>
{{end}}
